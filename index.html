<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>أحمد مجدي – متجر الكتب</title>
  <meta name="description" content="متجر كتب عربي احترافي: تصفّح، تفاصيل، تقييم بالنجوم، إعجاب، تعليقات، سلة، دفع بفودافون كاش." />
  <style>
    :root{
      --brand:#008ecc; --brand-2:#0672a8; --accent:#ffb703;
      --bg:#f6f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --shadow:0 8px 24px rgba(0,0,0,.08); --radius:16px; --nav-h:66px; --maxw:1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Cairo","Tahoma",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.65}
    a{color:inherit;text-decoration:none}
    /* ===== Header ===== */
    header{position:sticky;top:0;z-index:40;background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff;box-shadow:var(--shadow)}
    .topbar{max-width:var(--maxw);margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px;font-size:20px;cursor:pointer}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
    .search{margin-inline-start:auto;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.14);padding:8px 12px;border-radius:999px;min-width:200px;width:min(520px,58vw)}
    .search input{background:transparent;border:0;outline:0;color:#fff;width:100%;font-size:14px}
    .search input::placeholder{color:rgba(255,255,255,.8)}
    /* ===== Main & pages ===== */
    main{max-width:var(--maxw);margin:0 auto;padding:18px 16px calc(var(--nav-h) + 24px)}
    .page{display:none}.page.active{display:block}
    /* ===== Grid (3 mob / 4 laptop / 5 desktop) ===== */
    .grid{display:grid;gap:16px}
    /* default = mobile */
    .grid{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(min-width:1024px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}   /* laptop */
    @media(min-width:1440px){.grid{grid-template-columns:repeat(5,minmax(0,1fr))}}   /* desktop */
    .card{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);transition:transform .18s ease,box-shadow .18s ease;cursor:pointer;display:flex;flex-direction:column}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 28px rgba(0,0,0,.12)}
    .thumb{aspect-ratio:3/4;width:100%;object-fit:cover}
    .meta{padding:10px 12px 14px}.title{margin:0 0 6px;font-size:15px;font-weight:800}.price{font-size:14px;color:var(--brand-2);font-weight:800}
    /* ===== Details ===== */
    .details{display:grid;grid-template-columns:320px 1fr;gap:24px;align-items:start}
    @media(max-width:860px){.details{grid-template-columns:1fr}}
    .details img{width:100%;border-radius:var(--radius);box-shadow:var(--shadow);object-fit:cover}
    .badge{display:inline-block;background:#eef2ff;color:#1e3a8a;padding:4px 10px;border-radius:999px;font-size:12px;margin-inline-start:6px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{border:0;outline:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:800;transition:.18s ease;box-shadow:var(--shadow);font-size:14px}
    .btn.brand{background:var(--brand);color:#fff}.btn.brand:hover{background:var(--brand-2)}
    .btn.ghost{background:#fff}
    .muted{color:var(--muted);font-size:14px}
    .divider{height:1px;background:#e5e7eb;margin:16px 0}
    .like{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;background:#fff}
    .like.active{border-color:#ff4757;background:#ffecec}
    /* Stars */
    .stars{display:flex;gap:4px;font-size:22px;cursor:pointer}
    .star{opacity:.35;transition:opacity .15s}.star.on{opacity:1}
    /* Reviews list */
    .reviews .item{background:#fff;border-radius:12px;padding:12px 14px;box-shadow:var(--shadow);margin-bottom:10px}
    .add-comment{display:flex;gap:8px}.add-comment input{flex:1;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-size:14px}
    /* ===== Cart ===== */
    .cart-row{display:grid;grid-template-columns:68px 1fr auto auto;gap:12px;align-items:center;background:#fff;border-radius:14px;padding:10px 12px;box-shadow:var(--shadow);margin-bottom:10px}
    .cthumb{width:68px;height:92px;border-radius:10px;object-fit:cover}
    .qty{display:flex;align-items:center;gap:8px}.qty button{width:28px;height:28px;border-radius:8px;border:0;background:#eef2f7;cursor:pointer;font-weight:900}
    .totals{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:16px;padding:14px 16px;box-shadow:var(--shadow);margin-top:12px;font-weight:900}
    /* ===== Panels ===== */
    .panel{background:#fff;border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .panel input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;font-size:14px}
    /* ===== Bottom Nav ===== */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:var(--nav-h);z-index:50;background:#fff;border-top:1px solid #e5e7eb;display:flex;justify-content:space-around;align-items:center;box-shadow:0 -8px 18px rgba(0,0,0,.06)}
    .nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;color:#111;text-decoration:none;font-size:12px}
    .nav-item.active{color:var(--brand)}
    .pill{display:inline-flex;min-width:20px;height:20px;border-radius:999px;background:var(--accent);color:#111;font-weight:900;align-items:center;justify-content:center;font-size:12px;padding:0 6px}
    .hide{display:none!important}
  </style>
</head>
<body>

  <!-- ===== Header ===== -->
  <header>
    <div class="topbar">
      <!-- اللوجو الوحيد اللي يرجّع للرئيسية -->
      <div class="brand" onclick="showPage('books')">🟦 أحمد مجدي <span class="dot"></span></div>
      <label class="search">🔎
        <input id="q" type="search" placeholder="ابحث عن كتاب..." oninput="filterBooks(this.value)">
      </label>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main>
    <!-- صفحة الكتب -->
    <section id="page-books" class="page active">
      <div id="booksGrid" class="grid"></div>
    </section>

    <!-- صفحة التفاصيل -->
    <section id="page-details" class="page">
      <div class="details">
        <img id="dImg" alt="غلاف الكتاب">
        <div>
          <h2 id="dTitle" style="margin:.2rem 0 .4rem;font-size:26px;font-weight:900"></h2>
          <div class="muted">السعر: <b id="dPrice"></b> جنيه <span id="dBadge" class="badge">كتاب مميز</span></div>

          <div class="actions">
            <button class="btn brand" onclick="addCurrentToCart()">إضافة للسلة 🛒</button>
            <button id="likeBtn" class="btn like" onclick="toggleLike()">👍 <span id="likeTxt">إعجاب</span></button>
            <div class="stars" id="stars">
              <span class="star" data-v="1">★</span>
              <span class="star" data-v="2">★</span>
              <span class="star" data-v="3">★</span>
              <span class="star" data-v="4">★</span>
              <span class="star" data-v="5">★</span>
            </div>
            <button class="btn ghost" onclick="goBack()">رجوع للقائمة</button>
          </div>

          <div class="divider"></div>
          <p id="dDesc" style="font-size:15px"></p>
          <div class="muted" id="ratingInfo" style="margin-top:6px"></div>

          <div class="divider"></div>
          <div class="reviews">
            <h3 style="margin:0 0 8px">💬 التعليقات</h3>
            <div id="reviewsList"></div>
            <div class="add-comment" style="margin-top:10px">
              <input id="commentInput" type="text" placeholder="اكتب تعليقك واضغط إضافة...">
              <button class="btn brand" onclick="addComment()">إضافة</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- صفحة السلة -->
    <section id="page-cart" class="page">
      <h2 style="margin:0 0 10px">🛒 سلة المشتريات</h2>
      <div id="cartList"></div>
      <div class="totals">
        <div>الإجمالي: <span id="cartTotal">0</span> جنيه</div>
        <div class="qty">
          <button class="btn ghost" onclick="clearCart()">تفريغ السلة</button>
          <button class="btn brand" onclick="showPage('payment')">المتابعة للدفع</button>
        </div>
      </div>
    </section>

    <!-- الحساب والتسجيل -->
    <section id="page-account" class="page">
      <div class="panel">
        <h2 style="margin-top:0">👤 الحساب</h2>
        <p class="muted">يرجى التسجيل قبل الشراء أو التفاعل.</p>

        <div id="whenLoggedOut">
          <h3>التسجيل</h3>
          <div style="display:grid;gap:10px;max-width:520px">
            <button class="btn brand" onclick="googleLogin()">تسجيل بحساب Google</button>

            <div class="divider"></div>

            <label>أو برقم الهاتف:</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="phoneInput" placeholder="مثال: +20XXXXXXXXXX">
              <button class="btn ghost" onclick="sendOtp()">إرسال كود</button>
            </div>
            <div id="recaptcha-container"></div>
            <div id="otpBox" class="hide" style="display:flex;gap:8px;align-items:center">
              <input id="otpInput" placeholder="أدخل الكود المرسل">
              <button class="btn brand" onclick="confirmOtp()">تأكيد</button>
            </div>

            <div class="divider"></div>

            <label>أو بالبريد الإلكتروني:</label>
            <div style="display:grid;gap:8px;grid-template-columns:1fr 1fr">
              <input id="emailInput" placeholder="example@gmail.com">
              <input id="passInput" type="password" placeholder="كلمة المرور">
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn brand" onclick="emailSignup()">إنشاء حساب</button>
              <button class="btn ghost" onclick="emailLogin()">تسجيل الدخول</button>
            </div>
          </div>
        </div>

        <div id="whenLoggedIn" class="hide">
          <p>مرحبًا، <b id="userName"></b> 🎉</p>
          <p class="muted" id="userEmail"></p>
          <div class="actions" style="margin-top:8px">
            <button class="btn ghost" onclick="logout()">تسجيل الخروج</button>
          </div>
        </div>
      </div>
    </section>

    <!-- الدفع -->
    <section id="page-payment" class="page">
      <div class="panel">
        <h2 style="margin-top:0">💳 الدفع</h2>
        <p>حوّل المبلغ الإجمالي عبر <b>فودافون كاش</b> إلى الرقم:</p>
        <p style="font-size:22px;font-weight:900;color:#d00000;margin:.4rem 0">01553073695</p>
        <p class="muted">بعد التحويل، احتفظ برقم العملية وتواصل معنا لتأكيد الطلب.</p>
        <div class="divider"></div>
        <div><b>ملخص الطلب:</b></div>
        <div id="paySummary" class="muted" style="margin-top:6px"></div>
        <div class="actions" style="margin-top:10px">
          <button class="btn brand" onclick="confirmOrder()">تأكيد الدفع</button>
          <button class="btn ghost" onclick="showPage('cart')">رجوع للسلة</button>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Bottom Nav ===== -->
  <nav class="bottom-nav">
    <a id="nav-books" class="nav-item active" href="#" onclick="showPage('books')">🏠 <span>الرئيسية</span></a>
    <a id="nav-cart" class="nav-item" href="#" onclick="showPage('cart')">🛒 <span>السلة <span id="cartCount" class="pill">0</span></span></a>
    <a id="nav-account" class="nav-item" href="#" onclick="showPage('account')">👤 <span>الحساب</span></a>
    <a id="nav-payment" class="nav-item" href="#" onclick="showPage('payment')">💳 <span>الدفع</span></a>
  </nav>

  <!-- ===== Firebase SDKs ===== -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- ===== App Script ===== -->
  <script>
    /************ Firebase Config (عدّل البيانات) ************/
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    /************ بيانات 100 كتاب ************/
    const nouns=['الحكمة','القراءة','الإلهام','النجاح','الفشل','الصبر','الشجاعة','الهدوء','القيادة','التفاوض','الإبداع','الخيال','الطموح','العادات','التفكير','المعرفة','العلم','العمل','المستقبل','التكنولوجيا','اللغة','التاريخ','الفلسفة','الأدب','الرحلة','الطبيعة','الاقتصاد','المال','الإدارة','التسويق','البرمجة','التصميم','الموسيقى','التصوير','الشعر','الطبخ','الصحة','اللياقة','التربية','النفس','العلاقات','الوقت','المهارات','التواصل','الإقناع','التوازن','المرونة','القيم','الابتكار','التركيز','الإنتاجية','الوعي','العقل','التأثير','الريادة','الانضباط','الطاقة','الذهن','الخيارات','اتخاذ القرار','التعلّم','الذاكرة','الملاحظة','التحليل','الحياة','العمل الحر','الفن','السينما','السرد','القصة','الدراما','الرحلات','الطهي','البستنة','الطاقة الشمسية','البيانات','الذكاء الاصطناعي','الأمن الرقمي','الألعاب','الاستثمار','الأسواق','المحاسبة','المشاريع','القانون','الدبلوماسية','الأطفال','المدرسة','الجامعة','المنطق','الأخلاق','الكون','الفضاء','الطيران','المحيطات','البيئة','الزراعة','الترجمة','التدوين','الخط العربي','التغذية'];
    const adjectives=['المبسّط','العملي','المتقدم','للمبتدئين','الشامل','المكثّف','المرشد','الحديث','الفعّال','المنهجي','الإستراتيجي','اليومي','السريع','الإبداعي','المتوازن','العميق','الذهبي','الرقمي','المعاصر','المُلهم'];
    const starters=['فن','قوة','أسرار','دليل','مدخل إلى','رحلة إلى','خارطة طريق','أساسيات','مختصر','خطوة خطوة إلى'];
    const BOOKS = (()=>{ const set=new Set(),arr=[]; let i=0,g=0;
      const slug=s=>s.toLowerCase().replace(/\s+/g,'-').replace(/[^\u0600-\u06FFa-z0-9\-]/g,'');
      while(arr.length<100 && g<6000){g++; const form=i%5, n=nouns[i%nouns.length], a=adjectives[(i*3)%adjectives.length], st=starters[(i*7)%starters.length];
        let t=''; if(form===0)t=`${st} ${n}`; if(form===1)t=`${n} ${a}`; if(form===2)t=`${st} ${n} ${a}`; if(form===3)t=`طريق ${n}`; if(form===4)t=`لغة ${n}`;
        t=t.replace(/\s+/g,' ').trim(); if(!set.has(t)){set.add(t); const s=slug(t); const price=80+((i*7)%101);
          arr.push({id:s+'_'+(i+1), title:t, price, image:`https://picsum.photos/seed/${encodeURIComponent(s)}/400/560`,
            desc:`«${t}» يقدم أفكارًا عملية وقصصًا موجزة تساعدك على الفهم والتطبيق في حياتك اليومية. مناسب للقرّاء الباحثين عن محتوى واضح مع أمثلة واقعية.`});
        } i++;
      } return arr;
    })();

    /************ عناصر DOM ************/
    const booksGrid=document.getElementById('booksGrid'), qInput=document.getElementById('q');
    const dImg=document.getElementById('dImg'), dTitle=document.getElementById('dTitle'), dPrice=document.getElementById('dPrice'), dDesc=document.getElementById('dDesc'), dBadge=document.getElementById('dBadge'), ratingInfo=document.getElementById('ratingInfo');
    const reviewsList=document.getElementById('reviewsList'), commentInput=document.getElementById('commentInput');
    const cartList=document.getElementById('cartList'), cartTotalEl=document.getElementById('cartTotal'), cartCount=document.getElementById('cartCount'), paySummary=document.getElementById('paySummary');
    const whenLoggedOut=document.getElementById('whenLoggedOut'), whenLoggedIn=document.getElementById('whenLoggedIn'), userNameEl=document.getElementById('userName'), userEmailEl=document.getElementById('userEmail');

    /************ صفحات ************/
    function setActiveNav(id){['books','cart','account','payment'].forEach(k=>{
      const el=document.getElementById('nav-'+k); if(el) el.classList.toggle('active',k===id);
    })}
    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      if(id==='books'){document.getElementById('page-books').classList.add('active'); setActiveNav('books');}
      if(id==='details'){document.getElementById('page-details').classList.add('active'); setActiveNav('books');}
      if(id==='cart'){document.getElementById('page-cart').classList.add('active'); setActiveNav('cart'); updateCartUI();}
      if(id==='account'){document.getElementById('page-account').classList.add('active'); setActiveNav('account');}
      if(id==='payment'){document.getElementById('page-payment').classList.add('active'); setActiveNav('payment'); updateCartUI();}
      window.scrollTo({top:0,behavior:'smooth'});
    }

    /************ شبكة الكتب ************/
    function renderBooks(list=BOOKS){
      booksGrid.innerHTML='';
      list.forEach(b=>{
        const card=document.createElement('article');
        card.className='card';
        card.onclick=()=>openDetails(b.id); // الكتب تفتح صفحة تفاصيل
        card.innerHTML=`<img class="thumb" loading="lazy" src="${b.image}" alt="${b.title}">
          <div class="meta"><h3 class="title">${b.title}</h3><div class="price">${b.price} جنيه</div></div>`;
        booksGrid.appendChild(card);
      });
    }
    function filterBooks(q){q=(q||'').trim(); const list=!q?BOOKS:BOOKS.filter(b=>b.title.includes(q)); renderBooks(list);}

    /************ تفاصيل / إعجاب / نجوم / تعليقات ************/
    let currentBook=null, currentLike=false, currentMyRating=0;
    const starsEl=document.getElementById('stars'); const likeBtn=document.getElementById('likeBtn'); const likeTxt=document.getElementById('likeTxt');

    function requireAuth(){ if(!auth.currentUser){ alert('من فضلك سجّل الدخول أولًا.'); showPage('account'); return false;} return true; }

    async function openDetails(id){
      const b=BOOKS.find(x=>x.id===id); if(!b) return;
      currentBook=b; dImg.src=b.image; dTitle.textContent=b.title; dPrice.textContent=b.price; dDesc.textContent=b.desc; dBadge.textContent=(b.price>130?'الأكثر مبيعًا':'كتاب مختار');
      await loadLikeAndRating();
      await loadComments();
      showPage('details');
    }

    function updateStarsUI(val){[...starsEl.querySelectorAll('.star')].forEach(s=>s.classList.toggle('on', Number(s.dataset.v)<=val));}

    async function loadLikeAndRating(){
      const uid=auth.currentUser?.uid; // قد يكون null
      const likeDoc=await db.collection('books').doc(currentBook.id).collection('likes').doc(uid||'_anon').get();
      currentLike=likeDoc.exists ? !!likeDoc.data().v : false;
      likeBtn.classList.toggle('active', currentLike); likeTxt.textContent=currentLike?'إلغاء الإعجاب':'إعجاب';

      // حساب المتوسط بعد جلب كل التقييمات
      const snap=await db.collection('books').doc(currentBook.id).collection('ratings').get();
      const vals=snap.docs.map(d=>Number(d.data().v)||0); const avg=vals.length ? (vals.reduce((a,c)=>a+c,0)/vals.length) : 0;
      ratingInfo.textContent = `متوسط التقييم: ${avg.toFixed(1)} / 5 (${vals.length} صوت)`;

      // تهيئة تقييمي الشخصي
      if(uid){
        const my=await db.collection('books').doc(currentBook.id).collection('ratings').doc(uid).get();
        currentMyRating = my.exists ? (Number(my.data().v)||0) : 0;
      }else currentMyRating = 0;
      updateStarsUI(currentMyRating);
    }

    async function toggleLike(){
      if(!requireAuth()) return;
      const uid=auth.currentUser.uid;
      const ref=db.collection('books').doc(currentBook.id).collection('likes').doc(uid);
      currentLike=!currentLike;
      await ref.set({v:currentLike, ts:firebase.firestore.FieldValue.serverTimestamp()});
      likeBtn.classList.toggle('active', currentLike); likeTxt.textContent=currentLike?'إلغاء الإعجاب':'إعجاب';
    }

    starsEl.addEventListener('mouseover', e=>{
      const v=Number(e.target?.dataset?.v||0); if(!v) return; updateStarsUI(v);
    });
    starsEl.addEventListener('mouseleave', ()=>updateStarsUI(currentMyRating));
    starsEl.addEventListener('click', async e=>{
      if(!requireAuth()) return;
      const v=Number(e.target?.dataset?.v||0); if(!v) return;
      currentMyRating=v;
      await db.collection('books').doc(currentBook.id).collection('ratings').doc(auth.currentUser.uid)
        .set({v, ts:firebase.firestore.FieldValue.serverTimestamp()});
      updateStarsUI(v);
      // تحديث المتوسط
      const snap=await db.collection('books').doc(currentBook.id).collection('ratings').get();
      const vals=snap.docs.map(d=>Number(d.data().v)||0);
      const avg=vals.length?(vals.reduce((a,c)=>a+c,0)/vals.length):0;
      ratingInfo.textContent=`متوسط التقييم: ${avg.toFixed(1)} / 5 (${vals.length} صوت)`;
    });

    async function loadComments(){
      reviewsList.innerHTML='';
      const snap=await db.collection('books').doc(currentBook.id).collection('comments').orderBy('ts','desc').limit(50).get();
      if(snap.empty){ reviewsList.innerHTML='<div class="item muted">لا توجد تعليقات بعد.</div>'; return; }
      snap.forEach(d=>{
        const v=d.data();
        const el=document.createElement('div'); el.className='item';
        el.innerHTML=`<b>${v.name||'مستخدم'}</b> • <span class="muted">${new Date(v.ts?.toDate?.()||Date.now()).toLocaleString('ar-EG')}</span><br>${escapeHtml(v.text||'')}`;
        reviewsList.appendChild(el);
      });
    }

    async function addComment(){
      if(!requireAuth()) return;
      const text=(commentInput.value||'').trim(); if(!text) return;
      const u=auth.currentUser;
      await db.collection('books').doc(currentBook.id).collection('comments').add({
        uid:u.uid, name:u.displayName||u.phoneNumber||u.email||'مستخدم', text, ts:firebase.firestore.FieldValue.serverTimestamp()
      });
      commentInput.value=''; await loadComments();
    }

    function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]))}

    function goBack(){ showPage('books'); if(qInput.value) filterBooks(qInput.value); }

    /************ السلة ************/
    function cartKey(){return 'cart_v1'}
    function getCart(){try{return JSON.parse(localStorage.getItem(cartKey()))||[]}catch{return[]}}
    function saveCart(c){localStorage.setItem(cartKey(),JSON.stringify(c)); updateCartUI()}
    function addCurrentToCart(){ if(!requireAuth()) return; if(!currentBook) return;
      const c=getCart(); const i=c.findIndex(x=>x.id===currentBook.id);
      if(i>-1) c[i].qty+=1; else c.push({id:currentBook.id,title:currentBook.title,price:currentBook.price,image:currentBook.image,qty:1});
      saveCart(c);
    }
    function updateQty(id,delta){const c=getCart(); const i=c.findIndex(x=>x.id===id); if(i>-1){c[i].qty+=delta; if(c[i].qty<=0)c.splice(i,1); saveCart(c);}}
    function removeItem(id){saveCart(getCart().filter(x=>x.id!==id))}
    function clearCart(){saveCart([])}
    function updateCartUI(){
      const c=getCart(); const count=c.reduce((a,x)=>a+x.qty,0); cartCount.textContent=count;
      cartList.innerHTML=''; let total=0;
      c.forEach(it=>{total+=it.price*it.qty;
        const row=document.createElement('div'); row.className='cart-row';
        row.innerHTML=`<img class="cthumb" src="${it.image}" alt="${it.title}">
          <div><div style="font-weight:900">${it.title}</div><div class="muted">${it.price} ج × ${it.qty}</div></div>
          <div class="qty"><button onclick="updateQty('${it.id}',-1)">−</button><div>${it.qty}</div><button onclick="updateQty('${it.id}',1)">+</button></div>
          <button class="btn ghost" onclick="removeItem('${it.id}')">حذف</button>`;
        cartList.appendChild(row);
      });
      cartTotalEl.textContent=total;
      paySummary.innerHTML = c.length ? c.map(i=>`• ${i.title} — ${i.qty} × ${i.price} ج`).join('<br>') + `<div class="divider"></div><b>الإجمالي: ${total} جنيه</b>` : 'السلة فارغة.';
    }
    function confirmOrder(){
      const total=cartTotalEl.textContent||'0';
      alert('تم استلام طلبك بقيمة '+total+' جنيه. يرجى التحويل عبر فودافون كاش ثم تأكيد العملية. شكراً لك!');
    }

    /************ Auth ************/
    function updateAuthUI(user){
      if(user){
        whenLoggedOut.classList.add('hide');
        whenLoggedIn.classList.remove('hide');
        userNameEl.textContent=user.displayName||user.phoneNumber||user.email||'مستخدم';
        userEmailEl.textContent=user.email||user.phoneNumber||'—';
      }else{
        whenLoggedIn.classList.add('hide');
        whenLoggedOut.classList.remove('hide');
      }
    }
    auth.onAuthStateChanged(u=>{updateAuthUI(u);});

    async function googleLogin(){
      const provider=new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
      alert('تم تسجيل الدخول عبر Google');
    }

    // Phone OTP
    let confirmationResult=null, recaptcha=null;
    function ensureRecaptcha(){
      if(!recaptcha){
        recaptcha=new firebase.auth.RecaptchaVerifier('recaptcha-container',{size:'invisible'});
        recaptcha.render();
      }
    }
    async function sendOtp(){
      const phone=document.getElementById('phoneInput').value.trim();
      if(!phone) return alert('أدخل رقم الهاتف مع كود الدولة، مثال: +2010xxxxxxx');
      ensureRecaptcha();
      try{
        confirmationResult=await auth.signInWithPhoneNumber(phone, recaptcha);
        document.getElementById('otpBox').classList.remove('hide');
        alert('تم إرسال الكود. من فضلك تحقق من رسائل الهاتف.');
      }catch(e){ console.error(e); alert('تعذر إرسال الكود: '+e.message); }
    }
    async function confirmOtp(){
      const code=document.getElementById('otpInput').value.trim();
      if(!code || !confirmationResult) return;
      try{ await confirmationResult.confirm(code); alert('تم تسجيل الدخول برقم الهاتف'); }
      catch(e){ alert('كود غير صحيح: '+e.message); }
    }

    // Email/Password
    async function emailSignup(){
      const email=document.getElementById('emailInput').value.trim();
      const pass=document.getElementById('passInput').value;
      if(!email || !pass) return alert('أدخل البريد وكلمة المرور');
      try{ await auth.createUserWithEmailAndPassword(email,pass); alert('تم إنشاء الحساب'); }
      catch(e){ alert(e.message); }
    }
    async function emailLogin(){
      const email=document.getElementById('emailInput').value.trim();
      const pass=document.getElementById('passInput').value;
      if(!email || !pass) return alert('أدخل البريد وكلمة المرور');
      try{ await auth.signInWithEmailAndPassword(email,pass); alert('تم تسجيل الدخول'); }
      catch(e){ alert(e.message); }
    }
    async function logout(){ await auth.signOut(); alert('تم تسجيل الخروج'); }

    /************ تشغيل أولي ************/
    renderBooks(BOOKS); updateCartUI();

    // بحث محفوظ مؤقتًا
    const lastQ=sessionStorage.getItem('last_q')||''; if(lastQ){ qInput.value=lastQ; filterBooks(lastQ); }
    qInput.addEventListener('change',()=>sessionStorage.setItem('last_q',qInput.value||''));
  </script>
</body>
</html>
