<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø£Ø­Ù…Ø¯ Ù…Ø¬Ø¯ÙŠ â€“ Ù…ØªØ¬Ø± Ø§Ù„ÙƒØªØ¨</title>
  <meta name="description" content="Ù…ØªØ¬Ø± ÙƒØªØ¨ Ø¹Ø±Ø¨ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ: ØªØµÙÙ‘Ø­ØŒ ØªÙØ§ØµÙŠÙ„ØŒ ØªÙ‚ÙŠÙŠÙ… Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ…ØŒ Ø¥Ø¹Ø¬Ø§Ø¨ØŒ ØªØ¹Ù„ÙŠÙ‚Ø§ØªØŒ Ø³Ù„Ø©ØŒ Ø¯ÙØ¹ Ø¨ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´." />
  <style>
    :root{
      --brand:#008ecc; --brand-2:#0672a8; --accent:#ffb703;
      --bg:#f6f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --shadow:0 8px 24px rgba(0,0,0,.08); --radius:16px; --nav-h:66px; --maxw:1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Cairo","Tahoma",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.65}
    a{color:inherit;text-decoration:none}
    /* ===== Header ===== */
    header{position:sticky;top:0;z-index:40;background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff;box-shadow:var(--shadow)}
    .topbar{max-width:var(--maxw);margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px;font-size:20px;cursor:pointer}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
    .search{margin-inline-start:auto;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.14);padding:8px 12px;border-radius:999px;min-width:200px;width:min(520px,58vw)}
    .search input{background:transparent;border:0;outline:0;color:#fff;width:100%;font-size:14px}
    .search input::placeholder{color:rgba(255,255,255,.8)}
    /* ===== Main & pages ===== */
    main{max-width:var(--maxw);margin:0 auto;padding:18px 16px calc(var(--nav-h) + 24px)}
    .page{display:none}.page.active{display:block}
    /* ===== Grid (3 mob / 4 laptop / 5 desktop) ===== */
    .grid{display:grid;gap:16px}
    /* default = mobile */
    .grid{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(min-width:1024px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}   /* laptop */
    @media(min-width:1440px){.grid{grid-template-columns:repeat(5,minmax(0,1fr))}}   /* desktop */
    .card{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);transition:transform .18s ease,box-shadow .18s ease;cursor:pointer;display:flex;flex-direction:column}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 28px rgba(0,0,0,.12)}
    .thumb{aspect-ratio:3/4;width:100%;object-fit:cover}
    .meta{padding:10px 12px 14px}.title{margin:0 0 6px;font-size:15px;font-weight:800}.price{font-size:14px;color:var(--brand-2);font-weight:800}
    /* ===== Details ===== */
    .details{display:grid;grid-template-columns:320px 1fr;gap:24px;align-items:start}
    @media(max-width:860px){.details{grid-template-columns:1fr}}
    .details img{width:100%;border-radius:var(--radius);box-shadow:var(--shadow);object-fit:cover}
    .badge{display:inline-block;background:#eef2ff;color:#1e3a8a;padding:4px 10px;border-radius:999px;font-size:12px;margin-inline-start:6px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{border:0;outline:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:800;transition:.18s ease;box-shadow:var(--shadow);font-size:14px}
    .btn.brand{background:var(--brand);color:#fff}.btn.brand:hover{background:var(--brand-2)}
    .btn.ghost{background:#fff}
    .muted{color:var(--muted);font-size:14px}
    .divider{height:1px;background:#e5e7eb;margin:16px 0}
    .like{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;background:#fff}
    .like.active{border-color:#ff4757;background:#ffecec}
    /* Stars */
    .stars{display:flex;gap:4px;font-size:22px;cursor:pointer}
    .star{opacity:.35;transition:opacity .15s}.star.on{opacity:1}
    /* Reviews list */
    .reviews .item{background:#fff;border-radius:12px;padding:12px 14px;box-shadow:var(--shadow);margin-bottom:10px}
    .add-comment{display:flex;gap:8px}.add-comment input{flex:1;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-size:14px}
    /* ===== Cart ===== */
    .cart-row{display:grid;grid-template-columns:68px 1fr auto auto;gap:12px;align-items:center;background:#fff;border-radius:14px;padding:10px 12px;box-shadow:var(--shadow);margin-bottom:10px}
    .cthumb{width:68px;height:92px;border-radius:10px;object-fit:cover}
    .qty{display:flex;align-items:center;gap:8px}.qty button{width:28px;height:28px;border-radius:8px;border:0;background:#eef2f7;cursor:pointer;font-weight:900}
    .totals{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:16px;padding:14px 16px;box-shadow:var(--shadow);margin-top:12px;font-weight:900}
    /* ===== Panels ===== */
    .panel{background:#fff;border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .panel input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;font-size:14px}
    /* ===== Bottom Nav ===== */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:var(--nav-h);z-index:50;background:#fff;border-top:1px solid #e5e7eb;display:flex;justify-content:space-around;align-items:center;box-shadow:0 -8px 18px rgba(0,0,0,.06)}
    .nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;color:#111;text-decoration:none;font-size:12px}
    .nav-item.active{color:var(--brand)}
    .pill{display:inline-flex;min-width:20px;height:20px;border-radius:999px;background:var(--accent);color:#111;font-weight:900;align-items:center;justify-content:center;font-size:12px;padding:0 6px}
    .hide{display:none!important}
  </style>
</head>
<body>

  <!-- ===== Header ===== -->
  <header>
    <div class="topbar">
      <!-- Ø§Ù„Ù„ÙˆØ¬Ùˆ Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ù„ÙŠ ÙŠØ±Ø¬Ù‘Ø¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
      <div class="brand" onclick="showPage('books')">ğŸŸ¦ Ø£Ø­Ù…Ø¯ Ù…Ø¬Ø¯ÙŠ <span class="dot"></span></div>
      <label class="search">ğŸ”
        <input id="q" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨..." oninput="filterBooks(this.value)">
      </label>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main>
    <!-- ØµÙØ­Ø© Ø§Ù„ÙƒØªØ¨ -->
    <section id="page-books" class="page active">
      <div id="booksGrid" class="grid"></div>
    </section>

    <!-- ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
    <section id="page-details" class="page">
      <div class="details">
        <img id="dImg" alt="ØºÙ„Ø§Ù Ø§Ù„ÙƒØªØ§Ø¨">
        <div>
          <h2 id="dTitle" style="margin:.2rem 0 .4rem;font-size:26px;font-weight:900"></h2>
          <div class="muted">Ø§Ù„Ø³Ø¹Ø±: <b id="dPrice"></b> Ø¬Ù†ÙŠÙ‡ <span id="dBadge" class="badge">ÙƒØªØ§Ø¨ Ù…Ù…ÙŠØ²</span></div>

          <div class="actions">
            <button class="btn brand" onclick="addCurrentToCart()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© ğŸ›’</button>
            <button id="likeBtn" class="btn like" onclick="toggleLike()">ğŸ‘ <span id="likeTxt">Ø¥Ø¹Ø¬Ø§Ø¨</span></button>
            <div class="stars" id="stars">
              <span class="star" data-v="1">â˜…</span>
              <span class="star" data-v="2">â˜…</span>
              <span class="star" data-v="3">â˜…</span>
              <span class="star" data-v="4">â˜…</span>
              <span class="star" data-v="5">â˜…</span>
            </div>
            <button class="btn ghost" onclick="goBack()">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
          </div>

          <div class="divider"></div>
          <p id="dDesc" style="font-size:15px"></p>
          <div class="muted" id="ratingInfo" style="margin-top:6px"></div>

          <div class="divider"></div>
          <div class="reviews">
            <h3 style="margin:0 0 8px">ğŸ’¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h3>
            <div id="reviewsList"></div>
            <div class="add-comment" style="margin-top:10px">
              <input id="commentInput" type="text" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ ÙˆØ§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©...">
              <button class="btn brand" onclick="addComment()">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø³Ù„Ø© -->
    <section id="page-cart" class="page">
      <h2 style="margin:0 0 10px">ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
      <div id="cartList"></div>
      <div class="totals">
        <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="cartTotal">0</span> Ø¬Ù†ÙŠÙ‡</div>
        <div class="qty">
          <button class="btn ghost" onclick="clearCart()">ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
          <button class="btn brand" onclick="showPage('payment')">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø¯ÙØ¹</button>
        </div>
      </div>
    </section>

    <!-- Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ -->
    <section id="page-account" class="page">
      <div class="panel">
        <h2 style="margin-top:0">ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
        <p class="muted">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„ØªÙØ§Ø¹Ù„.</p>

        <div id="whenLoggedOut">
          <h3>Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
          <div style="display:grid;gap:10px;max-width:520px">
            <button class="btn brand" onclick="googleLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google</button>

            <div class="divider"></div>

            <label>Ø£Ùˆ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="phoneInput" placeholder="Ù…Ø«Ø§Ù„: +20XXXXXXXXXX">
              <button class="btn ghost" onclick="sendOtp()">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯</button>
            </div>
            <div id="recaptcha-container"></div>
            <div id="otpBox" class="hide" style="display:flex;gap:8px;align-items:center">
              <input id="otpInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±Ø³Ù„">
              <button class="btn brand" onclick="confirmOtp()">ØªØ£ÙƒÙŠØ¯</button>
            </div>

            <div class="divider"></div>

            <label>Ø£Ùˆ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
            <div style="display:grid;gap:8px;grid-template-columns:1fr 1fr">
              <input id="emailInput" placeholder="example@gmail.com">
              <input id="passInput" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn brand" onclick="emailSignup()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
              <button class="btn ghost" onclick="emailLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
          </div>
        </div>

        <div id="whenLoggedIn" class="hide">
          <p>Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ <b id="userName"></b> ğŸ‰</p>
          <p class="muted" id="userEmail"></p>
          <div class="actions" style="margin-top:8px">
            <button class="btn ghost" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Ø§Ù„Ø¯ÙØ¹ -->
    <section id="page-payment" class="page">
      <div class="panel">
        <h2 style="margin-top:0">ğŸ’³ Ø§Ù„Ø¯ÙØ¹</h2>
        <p>Ø­ÙˆÙ‘Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¨Ø± <b>ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</b> Ø¥Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù…:</p>
        <p style="font-size:22px;font-weight:900;color:#d00000;margin:.4rem 0">01553073695</p>
        <p class="muted">Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ØŒ Ø§Ø­ØªÙØ¸ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨.</p>
        <div class="divider"></div>
        <div><b>Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨:</b></div>
        <div id="paySummary" class="muted" style="margin-top:6px"></div>
        <div class="actions" style="margin-top:10px">
          <button class="btn brand" onclick="confirmOrder()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹</button>
          <button class="btn ghost" onclick="showPage('cart')">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø³Ù„Ø©</button>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Bottom Nav ===== -->
  <nav class="bottom-nav">
    <a id="nav-books" class="nav-item active" href="#" onclick="showPage('books')">ğŸ  <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
    <a id="nav-cart" class="nav-item" href="#" onclick="showPage('cart')">ğŸ›’ <span>Ø§Ù„Ø³Ù„Ø© <span id="cartCount" class="pill">0</span></span></a>
    <a id="nav-account" class="nav-item" href="#" onclick="showPage('account')">ğŸ‘¤ <span>Ø§Ù„Ø­Ø³Ø§Ø¨</span></a>
    <a id="nav-payment" class="nav-item" href="#" onclick="showPage('payment')">ğŸ’³ <span>Ø§Ù„Ø¯ÙØ¹</span></a>
  </nav>

  <!-- ===== Firebase SDKs ===== -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- ===== App Script ===== -->
  <script>
    /************ Firebase Config (Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) ************/
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    /************ Ø¨ÙŠØ§Ù†Ø§Øª 100 ÙƒØªØ§Ø¨ ************/
    const nouns=['Ø§Ù„Ø­ÙƒÙ…Ø©','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©','Ø§Ù„Ø¥Ù„Ù‡Ø§Ù…','Ø§Ù„Ù†Ø¬Ø§Ø­','Ø§Ù„ÙØ´Ù„','Ø§Ù„ØµØ¨Ø±','Ø§Ù„Ø´Ø¬Ø§Ø¹Ø©','Ø§Ù„Ù‡Ø¯ÙˆØ¡','Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©','Ø§Ù„ØªÙØ§ÙˆØ¶','Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹','Ø§Ù„Ø®ÙŠØ§Ù„','Ø§Ù„Ø·Ù…ÙˆØ­','Ø§Ù„Ø¹Ø§Ø¯Ø§Øª','Ø§Ù„ØªÙÙƒÙŠØ±','Ø§Ù„Ù…Ø¹Ø±ÙØ©','Ø§Ù„Ø¹Ù„Ù…','Ø§Ù„Ø¹Ù…Ù„','Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„','Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§','Ø§Ù„Ù„ØºØ©','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„ÙÙ„Ø³ÙØ©','Ø§Ù„Ø£Ø¯Ø¨','Ø§Ù„Ø±Ø­Ù„Ø©','Ø§Ù„Ø·Ø¨ÙŠØ¹Ø©','Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯','Ø§Ù„Ù…Ø§Ù„','Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©','Ø§Ù„ØªØ³ÙˆÙŠÙ‚','Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©','Ø§Ù„ØªØµÙ…ÙŠÙ…','Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰','Ø§Ù„ØªØµÙˆÙŠØ±','Ø§Ù„Ø´Ø¹Ø±','Ø§Ù„Ø·Ø¨Ø®','Ø§Ù„ØµØ­Ø©','Ø§Ù„Ù„ÙŠØ§Ù‚Ø©','Ø§Ù„ØªØ±Ø¨ÙŠØ©','Ø§Ù„Ù†ÙØ³','Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª','Ø§Ù„ÙˆÙ‚Øª','Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª','Ø§Ù„ØªÙˆØ§ØµÙ„','Ø§Ù„Ø¥Ù‚Ù†Ø§Ø¹','Ø§Ù„ØªÙˆØ§Ø²Ù†','Ø§Ù„Ù…Ø±ÙˆÙ†Ø©','Ø§Ù„Ù‚ÙŠÙ…','Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±','Ø§Ù„ØªØ±ÙƒÙŠØ²','Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©','Ø§Ù„ÙˆØ¹ÙŠ','Ø§Ù„Ø¹Ù‚Ù„','Ø§Ù„ØªØ£Ø«ÙŠØ±','Ø§Ù„Ø±ÙŠØ§Ø¯Ø©','Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·','Ø§Ù„Ø·Ø§Ù‚Ø©','Ø§Ù„Ø°Ù‡Ù†','Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª','Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø±','Ø§Ù„ØªØ¹Ù„Ù‘Ù…','Ø§Ù„Ø°Ø§ÙƒØ±Ø©','Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©','Ø§Ù„ØªØ­Ù„ÙŠÙ„','Ø§Ù„Ø­ÙŠØ§Ø©','Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø±','Ø§Ù„ÙÙ†','Ø§Ù„Ø³ÙŠÙ†Ù…Ø§','Ø§Ù„Ø³Ø±Ø¯','Ø§Ù„Ù‚ØµØ©','Ø§Ù„Ø¯Ø±Ø§Ù…Ø§','Ø§Ù„Ø±Ø­Ù„Ø§Øª','Ø§Ù„Ø·Ù‡ÙŠ','Ø§Ù„Ø¨Ø³ØªÙ†Ø©','Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ©','Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ','Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø±Ù‚Ù…ÙŠ','Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨','Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±','Ø§Ù„Ø£Ø³ÙˆØ§Ù‚','Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©','Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹','Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†','Ø§Ù„Ø¯Ø¨Ù„ÙˆÙ…Ø§Ø³ÙŠØ©','Ø§Ù„Ø£Ø·ÙØ§Ù„','Ø§Ù„Ù…Ø¯Ø±Ø³Ø©','Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©','Ø§Ù„Ù…Ù†Ø·Ù‚','Ø§Ù„Ø£Ø®Ù„Ø§Ù‚','Ø§Ù„ÙƒÙˆÙ†','Ø§Ù„ÙØ¶Ø§Ø¡','Ø§Ù„Ø·ÙŠØ±Ø§Ù†','Ø§Ù„Ù…Ø­ÙŠØ·Ø§Øª','Ø§Ù„Ø¨ÙŠØ¦Ø©','Ø§Ù„Ø²Ø±Ø§Ø¹Ø©','Ø§Ù„ØªØ±Ø¬Ù…Ø©','Ø§Ù„ØªØ¯ÙˆÙŠÙ†','Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø±Ø¨ÙŠ','Ø§Ù„ØªØºØ°ÙŠØ©'];
    const adjectives=['Ø§Ù„Ù…Ø¨Ø³Ù‘Ø·','Ø§Ù„Ø¹Ù…Ù„ÙŠ','Ø§Ù„Ù…ØªÙ‚Ø¯Ù…','Ù„Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ†','Ø§Ù„Ø´Ø§Ù…Ù„','Ø§Ù„Ù…ÙƒØ«Ù‘Ù','Ø§Ù„Ù…Ø±Ø´Ø¯','Ø§Ù„Ø­Ø¯ÙŠØ«','Ø§Ù„ÙØ¹Ù‘Ø§Ù„','Ø§Ù„Ù…Ù†Ù‡Ø¬ÙŠ','Ø§Ù„Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ','Ø§Ù„ÙŠÙˆÙ…ÙŠ','Ø§Ù„Ø³Ø±ÙŠØ¹','Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ','Ø§Ù„Ù…ØªÙˆØ§Ø²Ù†','Ø§Ù„Ø¹Ù…ÙŠÙ‚','Ø§Ù„Ø°Ù‡Ø¨ÙŠ','Ø§Ù„Ø±Ù‚Ù…ÙŠ','Ø§Ù„Ù…Ø¹Ø§ØµØ±','Ø§Ù„Ù…ÙÙ„Ù‡Ù…'];
    const starters=['ÙÙ†','Ù‚ÙˆØ©','Ø£Ø³Ø±Ø§Ø±','Ø¯Ù„ÙŠÙ„','Ù…Ø¯Ø®Ù„ Ø¥Ù„Ù‰','Ø±Ø­Ù„Ø© Ø¥Ù„Ù‰','Ø®Ø§Ø±Ø·Ø© Ø·Ø±ÙŠÙ‚','Ø£Ø³Ø§Ø³ÙŠØ§Øª','Ù…Ø®ØªØµØ±','Ø®Ø·ÙˆØ© Ø®Ø·ÙˆØ© Ø¥Ù„Ù‰'];
    const BOOKS = (()=>{ const set=new Set(),arr=[]; let i=0,g=0;
      const slug=s=>s.toLowerCase().replace(/\s+/g,'-').replace(/[^\u0600-\u06FFa-z0-9\-]/g,'');
      while(arr.length<100 && g<6000){g++; const form=i%5, n=nouns[i%nouns.length], a=adjectives[(i*3)%adjectives.length], st=starters[(i*7)%starters.length];
        let t=''; if(form===0)t=`${st} ${n}`; if(form===1)t=`${n} ${a}`; if(form===2)t=`${st} ${n} ${a}`; if(form===3)t=`Ø·Ø±ÙŠÙ‚ ${n}`; if(form===4)t=`Ù„ØºØ© ${n}`;
        t=t.replace(/\s+/g,' ').trim(); if(!set.has(t)){set.add(t); const s=slug(t); const price=80+((i*7)%101);
          arr.push({id:s+'_'+(i+1), title:t, price, image:`https://picsum.photos/seed/${encodeURIComponent(s)}/400/560`,
            desc:`Â«${t}Â» ÙŠÙ‚Ø¯Ù… Ø£ÙÙƒØ§Ø±Ù‹Ø§ Ø¹Ù…Ù„ÙŠØ© ÙˆÙ‚ØµØµÙ‹Ø§ Ù…ÙˆØ¬Ø²Ø© ØªØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ‡Ù… ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø­ÙŠØ§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©. Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù‚Ø±Ù‘Ø§Ø¡ Ø§Ù„Ø¨Ø§Ø­Ø«ÙŠÙ† Ø¹Ù† Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ø¶Ø­ Ù…Ø¹ Ø£Ù…Ø«Ù„Ø© ÙˆØ§Ù‚Ø¹ÙŠØ©.`});
        } i++;
      } return arr;
    })();

    /************ Ø¹Ù†Ø§ØµØ± DOM ************/
    const booksGrid=document.getElementById('booksGrid'), qInput=document.getElementById('q');
    const dImg=document.getElementById('dImg'), dTitle=document.getElementById('dTitle'), dPrice=document.getElementById('dPrice'), dDesc=document.getElementById('dDesc'), dBadge=document.getElementById('dBadge'), ratingInfo=document.getElementById('ratingInfo');
    const reviewsList=document.getElementById('reviewsList'), commentInput=document.getElementById('commentInput');
    const cartList=document.getElementById('cartList'), cartTotalEl=document.getElementById('cartTotal'), cartCount=document.getElementById('cartCount'), paySummary=document.getElementById('paySummary');
    const whenLoggedOut=document.getElementById('whenLoggedOut'), whenLoggedIn=document.getElementById('whenLoggedIn'), userNameEl=document.getElementById('userName'), userEmailEl=document.getElementById('userEmail');

    /************ ØµÙØ­Ø§Øª ************/
    function setActiveNav(id){['books','cart','account','payment'].forEach(k=>{
      const el=document.getElementById('nav-'+k); if(el) el.classList.toggle('active',k===id);
    })}
    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      if(id==='books'){document.getElementById('page-books').classList.add('active'); setActiveNav('books');}
      if(id==='details'){document.getElementById('page-details').classList.add('active'); setActiveNav('books');}
      if(id==='cart'){document.getElementById('page-cart').classList.add('active'); setActiveNav('cart'); updateCartUI();}
      if(id==='account'){document.getElementById('page-account').classList.add('active'); setActiveNav('account');}
      if(id==='payment'){document.getElementById('page-payment').classList.add('active'); setActiveNav('payment'); updateCartUI();}
      window.scrollTo({top:0,behavior:'smooth'});
    }

    /************ Ø´Ø¨ÙƒØ© Ø§Ù„ÙƒØªØ¨ ************/
    function renderBooks(list=BOOKS){
      booksGrid.innerHTML='';
      list.forEach(b=>{
        const card=document.createElement('article');
        card.className='card';
        card.onclick=()=>openDetails(b.id); // Ø§Ù„ÙƒØªØ¨ ØªÙØªØ­ ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„
        card.innerHTML=`<img class="thumb" loading="lazy" src="${b.image}" alt="${b.title}">
          <div class="meta"><h3 class="title">${b.title}</h3><div class="price">${b.price} Ø¬Ù†ÙŠÙ‡</div></div>`;
        booksGrid.appendChild(card);
      });
    }
    function filterBooks(q){q=(q||'').trim(); const list=!q?BOOKS:BOOKS.filter(b=>b.title.includes(q)); renderBooks(list);}

    /************ ØªÙØ§ØµÙŠÙ„ / Ø¥Ø¹Ø¬Ø§Ø¨ / Ù†Ø¬ÙˆÙ… / ØªØ¹Ù„ÙŠÙ‚Ø§Øª ************/
    let currentBook=null, currentLike=false, currentMyRating=0;
    const starsEl=document.getElementById('stars'); const likeBtn=document.getElementById('likeBtn'); const likeTxt=document.getElementById('likeTxt');

    function requireAuth(){ if(!auth.currentUser){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§.'); showPage('account'); return false;} return true; }

    async function openDetails(id){
      const b=BOOKS.find(x=>x.id===id); if(!b) return;
      currentBook=b; dImg.src=b.image; dTitle.textContent=b.title; dPrice.textContent=b.price; dDesc.textContent=b.desc; dBadge.textContent=(b.price>130?'Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ù‹Ø§':'ÙƒØªØ§Ø¨ Ù…Ø®ØªØ§Ø±');
      await loadLikeAndRating();
      await loadComments();
      showPage('details');
    }

    function updateStarsUI(val){[...starsEl.querySelectorAll('.star')].forEach(s=>s.classList.toggle('on', Number(s.dataset.v)<=val));}

    async function loadLikeAndRating(){
      const uid=auth.currentUser?.uid; // Ù‚Ø¯ ÙŠÙƒÙˆÙ† null
      const likeDoc=await db.collection('books').doc(currentBook.id).collection('likes').doc(uid||'_anon').get();
      currentLike=likeDoc.exists ? !!likeDoc.data().v : false;
      likeBtn.classList.toggle('active', currentLike); likeTxt.textContent=currentLike?'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨':'Ø¥Ø¹Ø¬Ø§Ø¨';

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
      const snap=await db.collection('books').doc(currentBook.id).collection('ratings').get();
      const vals=snap.docs.map(d=>Number(d.data().v)||0); const avg=vals.length ? (vals.reduce((a,c)=>a+c,0)/vals.length) : 0;
      ratingInfo.textContent = `Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${avg.toFixed(1)} / 5 (${vals.length} ØµÙˆØª)`;

      // ØªÙ‡ÙŠØ¦Ø© ØªÙ‚ÙŠÙŠÙ…ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ
      if(uid){
        const my=await db.collection('books').doc(currentBook.id).collection('ratings').doc(uid).get();
        currentMyRating = my.exists ? (Number(my.data().v)||0) : 0;
      }else currentMyRating = 0;
      updateStarsUI(currentMyRating);
    }

    async function toggleLike(){
      if(!requireAuth()) return;
      const uid=auth.currentUser.uid;
      const ref=db.collection('books').doc(currentBook.id).collection('likes').doc(uid);
      currentLike=!currentLike;
      await ref.set({v:currentLike, ts:firebase.firestore.FieldValue.serverTimestamp()});
      likeBtn.classList.toggle('active', currentLike); likeTxt.textContent=currentLike?'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨':'Ø¥Ø¹Ø¬Ø§Ø¨';
    }

    starsEl.addEventListener('mouseover', e=>{
      const v=Number(e.target?.dataset?.v||0); if(!v) return; updateStarsUI(v);
    });
    starsEl.addEventListener('mouseleave', ()=>updateStarsUI(currentMyRating));
    starsEl.addEventListener('click', async e=>{
      if(!requireAuth()) return;
      const v=Number(e.target?.dataset?.v||0); if(!v) return;
      currentMyRating=v;
      await db.collection('books').doc(currentBook.id).collection('ratings').doc(auth.currentUser.uid)
        .set({v, ts:firebase.firestore.FieldValue.serverTimestamp()});
      updateStarsUI(v);
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªÙˆØ³Ø·
      const snap=await db.collection('books').doc(currentBook.id).collection('ratings').get();
      const vals=snap.docs.map(d=>Number(d.data().v)||0);
      const avg=vals.length?(vals.reduce((a,c)=>a+c,0)/vals.length):0;
      ratingInfo.textContent=`Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${avg.toFixed(1)} / 5 (${vals.length} ØµÙˆØª)`;
    });

    async function loadComments(){
      reviewsList.innerHTML='';
      const snap=await db.collection('books').doc(currentBook.id).collection('comments').orderBy('ts','desc').limit(50).get();
      if(snap.empty){ reviewsList.innerHTML='<div class="item muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯.</div>'; return; }
      snap.forEach(d=>{
        const v=d.data();
        const el=document.createElement('div'); el.className='item';
        el.innerHTML=`<b>${v.name||'Ù…Ø³ØªØ®Ø¯Ù…'}</b> â€¢ <span class="muted">${new Date(v.ts?.toDate?.()||Date.now()).toLocaleString('ar-EG')}</span><br>${escapeHtml(v.text||'')}`;
        reviewsList.appendChild(el);
      });
    }

    async function addComment(){
      if(!requireAuth()) return;
      const text=(commentInput.value||'').trim(); if(!text) return;
      const u=auth.currentUser;
      await db.collection('books').doc(currentBook.id).collection('comments').add({
        uid:u.uid, name:u.displayName||u.phoneNumber||u.email||'Ù…Ø³ØªØ®Ø¯Ù…', text, ts:firebase.firestore.FieldValue.serverTimestamp()
      });
      commentInput.value=''; await loadComments();
    }

    function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]))}

    function goBack(){ showPage('books'); if(qInput.value) filterBooks(qInput.value); }

    /************ Ø§Ù„Ø³Ù„Ø© ************/
    function cartKey(){return 'cart_v1'}
    function getCart(){try{return JSON.parse(localStorage.getItem(cartKey()))||[]}catch{return[]}}
    function saveCart(c){localStorage.setItem(cartKey(),JSON.stringify(c)); updateCartUI()}
    function addCurrentToCart(){ if(!requireAuth()) return; if(!currentBook) return;
      const c=getCart(); const i=c.findIndex(x=>x.id===currentBook.id);
      if(i>-1) c[i].qty+=1; else c.push({id:currentBook.id,title:currentBook.title,price:currentBook.price,image:currentBook.image,qty:1});
      saveCart(c);
    }
    function updateQty(id,delta){const c=getCart(); const i=c.findIndex(x=>x.id===id); if(i>-1){c[i].qty+=delta; if(c[i].qty<=0)c.splice(i,1); saveCart(c);}}
    function removeItem(id){saveCart(getCart().filter(x=>x.id!==id))}
    function clearCart(){saveCart([])}
    function updateCartUI(){
      const c=getCart(); const count=c.reduce((a,x)=>a+x.qty,0); cartCount.textContent=count;
      cartList.innerHTML=''; let total=0;
      c.forEach(it=>{total+=it.price*it.qty;
        const row=document.createElement('div'); row.className='cart-row';
        row.innerHTML=`<img class="cthumb" src="${it.image}" alt="${it.title}">
          <div><div style="font-weight:900">${it.title}</div><div class="muted">${it.price} Ø¬ Ã— ${it.qty}</div></div>
          <div class="qty"><button onclick="updateQty('${it.id}',-1)">âˆ’</button><div>${it.qty}</div><button onclick="updateQty('${it.id}',1)">+</button></div>
          <button class="btn ghost" onclick="removeItem('${it.id}')">Ø­Ø°Ù</button>`;
        cartList.appendChild(row);
      });
      cartTotalEl.textContent=total;
      paySummary.innerHTML = c.length ? c.map(i=>`â€¢ ${i.title} â€” ${i.qty} Ã— ${i.price} Ø¬`).join('<br>') + `<div class="divider"></div><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø¬Ù†ÙŠÙ‡</b>` : 'Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©.';
    }
    function confirmOrder(){
      const total=cartTotalEl.textContent||'0';
      alert('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù‚ÙŠÙ…Ø© '+total+' Ø¬Ù†ÙŠÙ‡. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¹Ø¨Ø± ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ Ø«Ù… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ!');
    }

    /************ Auth ************/
    function updateAuthUI(user){
      if(user){
        whenLoggedOut.classList.add('hide');
        whenLoggedIn.classList.remove('hide');
        userNameEl.textContent=user.displayName||user.phoneNumber||user.email||'Ù…Ø³ØªØ®Ø¯Ù…';
        userEmailEl.textContent=user.email||user.phoneNumber||'â€”';
      }else{
        whenLoggedIn.classList.add('hide');
        whenLoggedOut.classList.remove('hide');
      }
    }
    auth.onAuthStateChanged(u=>{updateAuthUI(u);});

    async function googleLogin(){
      const provider=new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
      alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Google');
    }

    // Phone OTP
    let confirmationResult=null, recaptcha=null;
    function ensureRecaptcha(){
      if(!recaptcha){
        recaptcha=new firebase.auth.RecaptchaVerifier('recaptcha-container',{size:'invisible'});
        recaptcha.render();
      }
    }
    async function sendOtp(){
      const phone=document.getElementById('phoneInput').value.trim();
      if(!phone) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø©ØŒ Ù…Ø«Ø§Ù„: +2010xxxxxxx');
      ensureRecaptcha();
      try{
        confirmationResult=await auth.signInWithPhoneNumber(phone, recaptcha);
        document.getElementById('otpBox').classList.remove('hide');
        alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯. Ù…Ù† ÙØ¶Ù„Ùƒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‡Ø§ØªÙ.');
      }catch(e){ console.error(e); alert('ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯: '+e.message); }
    }
    async function confirmOtp(){
      const code=document.getElementById('otpInput').value.trim();
      if(!code || !confirmationResult) return;
      try{ await confirmationResult.confirm(code); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'); }
      catch(e){ alert('ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­: '+e.message); }
    }

    // Email/Password
    async function emailSignup(){
      const email=document.getElementById('emailInput').value.trim();
      const pass=document.getElementById('passInput').value;
      if(!email || !pass) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
      try{ await auth.createUserWithEmailAndPassword(email,pass); alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨'); }
      catch(e){ alert(e.message); }
    }
    async function emailLogin(){
      const email=document.getElementById('emailInput').value.trim();
      const pass=document.getElementById('passInput').value;
      if(!email || !pass) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
      try{ await auth.signInWithEmailAndPassword(email,pass); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); }
      catch(e){ alert(e.message); }
    }
    async function logout(){ await auth.signOut(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); }

    /************ ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ************/
    renderBooks(BOOKS); updateCartUI();

    // Ø¨Ø­Ø« Ù…Ø­ÙÙˆØ¸ Ù…Ø¤Ù‚ØªÙ‹Ø§
    const lastQ=sessionStorage.getItem('last_q')||''; if(lastQ){ qInput.value=lastQ; filterBooks(lastQ); }
    qInput.addEventListener('change',()=>sessionStorage.setItem('last_q',qInput.value||''));
  </script>
</body>
</html>
